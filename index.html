<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <title>canvas-select示例</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    .container {
      width: 100%;
      height: 100%;
    }

    #canvas {
      position: absolute;
      border: 1px solid black;
      width: 100%;
      height: 100%;
    }

    /* 自定义圆形光标 */
    #customCursor {
      position: absolute;
      pointer-events: none;  /* 禁止光标捕获点击事件 */
      border-radius: 50%;    /* 圆形 */
      background-color: rgba(0, 0, 0, 0.5);  /* 半透明黑色 */
      transform: translate(-50%, -50%);  /* 将光标居中 */
      z-index: 10; /* 确保光标位于画布上方 */
    }

    #image-canvas {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    #temp-canvas {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .right {
      margin-left: 20px;
    }

    #output {
      height: 450px;
      width: 400px;
    }
    
  </style>
</head>

<body>
  <div class="box">
    <div>
      <canvas id="canvas" class="container"></canvas>
      <canvas id="image-canvas" class="image"></canvas>
      <canvas id="temp-canvas" style="pointer-events: none;"></canvas>

      <!-- 自定义圆形光标 -->
      <div id="customCursor"></div>

      <div style="position: absolute; top: 600px;">
        <button onclick="change(1)">创建矩形</button>
        <button onclick="change(2)">创建多边形</button>
        <button onclick="change(3)">创建点</button>
        <button onclick="change(4)">创建折线</button>
        <button onclick="change(5)">创建圆形</button>
        <button onclick="change(6)">创建网格</button>
        <button onclick="change(0)">取消创建</button>
        <br />
        <button onclick="zoom(true)">放大</button>
        <button onclick="zoom(false)">缩小</button>
        <button onclick="fitting()">适配</button>
        <button onclick="focusMode()">专注模式</button>
        <button onclick="hideShape()">隐藏</button>
        <button onclick="showShape()">显示</button>
        <button onclick="clearAll()">清空图形</button>
        <button onclick="undo()">撤销</button>
        <button onclick="redo()">重做</button>
        <button onclick="change(7)">画笔</button>        
        <button onclick="eraser()">橡皮擦</button>
        <button onclick="nocolor()">透明色</button>
        <button onclick="changeCanvas()">扩大画布</button>
        <button onclick="saveImage()">保存图片</button>
        <button onclick="getAllMask()">分割一切</button>
        <button onclick="magicClick()">智能标注</button>
        <div>
          <span>颜色：</span>
          <input type="color" id="colorSelect" onchange="handleColorChange(this)"/>
        </div>
        <div>
          <span>宽度：</span>
          <input type="range" min="10" max="20" value="1" id="widthRange" onchange="handleWidthChange(this)"/>
          <span id="widthValue">10</span>
        </div>
      </div>
      </div>
    </div>
  </div>

  <script src="./lib/canvas-select.min.js"></script>
  <script>
    // 获取 canvas 元素
    const canvasElement = document.querySelector('canvas.container');
    const customCursor = document.getElementById('customCursor');
    const output = document.getElementById('output');

    // const instance = new CanvasSelect('.container', 'https://cdn.pixabay.com/photo/2023/11/03/12/22/toadstool-8362901_1280.jpg');
    const instance = new CanvasSelect('.container', 'https://cdn.pixabay.com/photo/2023/11/03/12/22/toadstool-8362901_1280.jpg');
    const instance1 = new CanvasSelect('.image', 'https://cdn.pixabay.com/photo/2023/11/03/12/22/toadstool-8362901_1280.jpg');
    // const instance = new CanvasSelect('.container', 'https://aircas.icu/admin/sys-file/dataset/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E9%9B%860821/base/train/daisy/326fb39312f2496a8a24cd80d868c017.jpg');
    // const instance1 = new CanvasSelect('.image', 'https://aircas.icu/admin/sys-file/dataset/%E6%B5%8B%E8%AF%95%E5%9F%BA%E7%A1%80%E6%95%B0%E6%8D%AE%E9%9B%860821/base/train/daisy/326fb39312f2496a8a24cd80d868c017.jpg');
    // instance.ctrlRadius = navigator.userAgent.includes('Mobile') ? 6 : 3;
    // window.c = instance;

    // for drawer
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    // for image
    const imageCanvas = document.getElementById('image-canvas');
    const imageContext = imageCanvas.getContext('2d');
    imageCanvas.style.zIndex = -1;
    // for rect real-time visualization
    const tempCanvas = document.getElementById('temp-canvas');
    const tempContext = tempCanvas.getContext('2d');
    tempCanvas.style.zIndex = 1;
    // for image-size mask canvas
    const maskcanvas = document.createElement('canvas');
    const maskcontext = maskcanvas.getContext('2d');
    instance.resize(800, 554, 0.2);
    instance1.resize(800, 554);
    
    // 处理颜色选择器的 change 事件
    function handleColorChange(input) {
      instance.brushstrokeStyle = input.value;
      // instance.activebrushstrokeStyle = input.value;
    }

    // 处理宽度选择器的 change 事件
    function handleWidthChange(input) {
      instance.brushlineWidth = parseInt(input.value, 10);
      document.getElementById('widthValue').textContent = input.value;
      setCursorRadius(instance.brushlineWidth);
    }
    let option = [
      // {
      //   label: "矩形",
      //   coor: [[150, 150], [275, 275]],
      //   type: 1
      // },
      // {
      //   label: "多边形",
      //   coor: [[135, 291], [129, 319], [146, 346], [174, 365], [214, 362], [196, 337], [161, 288]],
      //   type: 2
      // },
      {
        label: "点",
        coor: [85, 105],
        color: 'red',
        type: 3
      },
      // {
      //   label: "折线",
      //   coor: [[470, 155], [490, 230], [493, 298]],
      //   type: 4
      // },
      // {
      //   label: "圆形",
      //   coor: [369, 197],
      //   radius: 38,
      //   type: 5
      // },
      // {
      //   label: "网格",
      //   coor: [[419, 40], [539, 101]],
      //   type: 6,
      //   row: 3,
      //   col: 2,
      //   selected: [4]
      // },
    ];
    let option1 = [
      {
        maskBase64:"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",
        type: 8,
        maskType: 'everything',
      },
    ];

    instance.on('load', (src) => {
      console.log('图片加载完成', src);
      // instance.setData(option);
    });

    instance.on('scale', (info) => {
        instance1.mouse = instance.mouse;
        instance1.setScale(info.type, info.byMouse, info.pure);
    });

    instance.on('dragimg', () => {
      instance1.originX = instance.originX;
      instance1.originY = instance.originY;
      instance1.update();
    });

    instance.on('warn', (msg) => {
      console.warn('warn', msg);
    });

    instance.on('add', (info) => {
      console.log('当前添加', info);
      window.info = info;
    });

    instance.on('delete', (info) => {
      console.log('当前删除', info);
    });

    instance.on('select', (info) => {
      console.log('当前选中', info);
    });

    instance.on('updated', (result) => {
      console.log('标注结果', result);
      console.log("this.activeShape", this.activeShape);
    });

    instance.on('contextmenu', () => {
      console.log('右键');
    });

    let mousedown = false;

    // 添加鼠标移动事件监听器
    if (canvasElement) {
      const handleMouseMove = (e) => {
        const rect = canvasElement.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // 更新自定义光标位置
        customCursor.style.left = `${x}px`;
        customCursor.style.top = `${y}px`;
        if (!mousedown) {
          if (instance.hitOnShapeVertex(instance.mouse)) {
            canvasElement.style.cursor = instance.hitOnShapeVertex(instance.mouse);
          } else if (instance.hitOnShape(instance.mouse)[0] > -1) {
            canvasElement.style.cursor = 'move'; // 设置为移动光标
          } else {
            // canvasElement.style.cursor = "url('/mouseicon.png') 0 0, pointer";
            // canvasElement.style.cursor = "url('https://cdn-icons-png.flaticon.com/32/32/32177.png') 0 0, pointer";
            if(instance.createType === 7){
              canvasElement.style.cursor = 'none'; 
            }else{
              canvasElement.style.cursor = 'default'; 
            }
          }
        }
      };

      const handleMouseDown = () => {
        mousedown = true;
      }

      const handleMouseUp = () => {
        mousedown = false;
      }

      canvasElement.addEventListener('mousemove', handleMouseMove);
      canvasElement.addEventListener('mousedown', handleMouseDown);
      canvasElement.addEventListener('mouseup', handleMouseUp);
      window.addEventListener('beforeunload', () => {
        canvasElement.removeEventListener('mousemove', handleMouseMove);
        canvasElement.removeEventListener('mousedown', handleMouseDown);
        canvasElement.removeEventListener('mouseup', handleMouseUp);
      });
    }

    // 设置自定义光标初始样式
    function setCursorRadius(newRadius) {
      radius = newRadius;
      customCursor.style.width = `${radius * instance.scale}px`;
      customCursor.style.height = `${radius * instance.scale}px`;
    }

    setCursorRadius(instance.brushlineWidth);

    function change(num) {
      instance.createType = num;
      if(num===7){
      }
      console.log("instance.createType", instance.createType);
    }

    function getAllMask() {
      instance.setData(option);
      instance1.setData(option1);
    }

    function magicClick() {

    }

    function eraser() {
      instance.isEraser = !instance.isEraser;
      console.log("instance.isEraser", instance.isEraser);
      change(7);
    }

    function nocolor() {
      instance.activeStrokeStyle = "transparent";
    }

    function zoom(type) {
      instance.setScale(type);
    }

    function fitting() {
      instance.fitZoom();
      instance1.fitZoom();
    }

    function focusMode() {
      instance.setFocusMode(!instance.focusMode);
    }

    function hideShape() {
      instance.hideActiveShape(instance.activeShape.uuid)
    }

    function showShape() {
      instance.showHiddenShape();
    }

    function clearAll() {
      instance.deleteAllShape();
    }

    function undo() {
      instance.undo();
      console.log('instance.hideList.length', instance.hideList.length)
      console.log('instance.focusMode', instance.focusMode)
    }

    function redo() {
      instance.redo();
      console.log('instance.hideList.length', instance.hideList.length)
      console.log('instance.focusMode', instance.focusMode)
    }

    function changeData() {
      const data = JSON.parse(output.value);
      instance.setData(data);
    }

    function changeCanvas(){
      instance.resize(800, 554);
    }

    function saveImage() {
      // 获取 Canvas 上的内容并转换为数据 URL
      const imageDataUrl = this.canvas.toDataURL('image/png');

      // 创建一个下载链接并触发下载
      const downloadLink = document.createElement('a');
      downloadLink.href = imageDataUrl;
      downloadLink.download = 'canvas_image.png'; // 设定下载的文件名
      downloadLink.click();
    }
  </script>
</body>

</html>